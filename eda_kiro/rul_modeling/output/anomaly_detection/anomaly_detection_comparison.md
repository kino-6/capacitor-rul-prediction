# 異常検知アプローチの比較分析

**作成日**: 2026-01-17  
**目的**: 3つの異常検知アプローチの結果を比較し、最適な手法を特定する

---

## 📊 実装したアプローチ

### 1. Isolation Forest（タスク2.2a）

**アプローチ**:
- 教師なし学習による外れ値検出
- 全サイクルのデータから異常を検出
- 11個の本質的特徴量を使用（効率系含む）

**使用特徴量**:
- エネルギー転送: response_efficiency, voltage_ratio, peak_voltage_ratio, rms_voltage_ratio
- 波形類似度: waveform_correlation, vo_variability, vl_variability
- 応答遅延: response_delay, response_delay_normalized
- 高度な特徴: residual_energy_ratio, vo_complexity

**結果**:
- 異常検出率: 10.0%（160/1600サンプル）
- 問題点: 初期の高効率状態を異常として誤検出
- 異常サンプルの平均Response Efficiency: 2795（正常: 1158）
- 物理的妥当性: ❌ 低い（高効率を異常判定）

**結論**: 効率系特徴量の中期ピークにより、初期状態を異常として誤検出

---

### 2. One-Class SVM v1（タスク2.2b）

**アプローチ**:
- 初期サイクル（1-10）を正常として学習
- RBFカーネルで非線形境界を学習
- 11個の本質的特徴量を使用（効率系含む）

**使用特徴量**:
- Isolation Forestと同じ11特徴量

**結果**:
- 異常検出率: 93.4%（1494/1600サンプル）
- 問題点: 効率系特徴量の中期ピークにより、中期サイクルを正常判定
- Response Efficiencyの推移:
  - 初期（1-10）: 3.4
  - 中期（50-60）: 1760.58（異常な高値）
  - 後期（190-200）: 1.1
- 物理的妥当性: ❌ 低い（U字型パターンは物理的に不可能）

**結論**: 効率系特徴量が劣化の結果であり、予測指標として不適切

---

### 3. One-Class SVM v2（タスク2.2c）✅ 推奨

**アプローチ**:
- 初期サイクル（1-10）を正常として学習
- RBFカーネルで非線形境界を学習
- **7個の波形特性のみ使用（効率系除外）**

**使用特徴量**（波形特性のみ）:
- waveform_correlation（劣化で1.0に近づく）
- vo_variability（劣化で増加）
- vl_variability（劣化で増加）
- response_delay（応答遅延）
- response_delay_normalized（正規化遅延）
- residual_energy_ratio（残差エネルギー）
- vo_complexity（波形複雑度）

**除外した特徴量**（効率系、劣化の結果の可能性）:
- response_efficiency（中期に異常ピーク）
- voltage_ratio（中期に異常ピーク）
- peak_voltage_ratio（voltage_ratioと同様）
- rms_voltage_ratio（voltage_ratioと同様）

**結果**:
- 異常検出率: 91.9%（1471/1600サンプル）
- サイクル範囲別異常検出率:
  - Cycles 1-50: 77.0%（初期サイクルの一部を正常判定）
  - Cycles 51-100: 100.0%（完全に異常検出）
  - Cycles 101-150: 91.8%
  - Cycles 151-200: 99.0%（ほぼ完全に異常検出）

**波形特性の変化**（正常 vs 異常）:
| 特徴量 | 正常平均 | 異常平均 | 変化率 |
|--------|----------|----------|--------|
| waveform_correlation | 0.77 | 0.91 | +18.6% |
| vo_variability | 0.23 | 0.49 | +110.2% |
| vl_variability | 0.25 | 0.73 | +194.4% |
| residual_energy_ratio | 0.0017 | 0.0117 | +582.8% |

**効率系特徴量（検証用）**:
| 特徴量 | 正常平均 | 異常平均 | 変化率 |
|--------|----------|----------|--------|
| response_efficiency | 5.3 | 1437.0 | +26,886% |
| voltage_ratio | 1.3 | 41.3 | +3,009% |

**物理的妥当性**: ✅ 高い
- 初期サイクル（1-10）を正常として学習
- 劣化に伴う波形変化を単調に検出
- 効率系特徴量の異常ピークを回避
- 波形の単純化（correlation→1.0）と不安定化（variability↑）を検出

**結論**: 波形特性のみで物理的に妥当な異常検知が可能

---

## 🔍 比較分析

### 異常検出率の比較

| アプローチ | 異常検出率 | Cycles 1-50 | Cycles 51-100 | Cycles 101-150 | Cycles 151-200 |
|-----------|-----------|-------------|---------------|----------------|----------------|
| Isolation Forest | 10.0% | - | - | - | - |
| One-Class SVM v1 | 93.4% | - | - | - | - |
| **One-Class SVM v2** | **91.9%** | **77.0%** | **100.0%** | **91.8%** | **99.0%** |

### 物理的妥当性の比較

| アプローチ | 初期状態の扱い | 中期状態の扱い | 後期状態の扱い | 物理的妥当性 |
|-----------|---------------|---------------|---------------|-------------|
| Isolation Forest | 異常判定（誤検出） | 正常判定 | 正常判定 | ❌ 低い |
| One-Class SVM v1 | 正常（学習データ） | 正常判定（誤検出） | 異常判定 | ❌ 低い |
| **One-Class SVM v2** | **正常（学習データ）** | **異常判定** | **異常判定** | **✅ 高い** |

### 特徴量の有効性

| 特徴量カテゴリ | Isolation Forest | One-Class SVM v1 | One-Class SVM v2 |
|---------------|-----------------|-----------------|-----------------|
| 効率系特徴量 | 使用（問題あり） | 使用（問題あり） | **除外** |
| 波形特性 | 使用 | 使用 | **使用** |
| 応答遅延 | 使用 | 使用 | 使用 |

---

## 💡 重要な発見

### 1. 効率系特徴量の問題

**Response Efficiencyの推移**（One-Class SVM v1の結果）:
- 初期（1-10）: 3.4
- 中期（50-60）: 1760.58（異常な高値）
- 後期（190-200）: 1.1

**問題点**:
- 中期に異常なピーク値を示す（物理的に不可能）
- コンデンサは劣化から回復しない（単調減少が期待される）
- 効率変化は劣化の**結果**であり、**予測指標**ではない

### 2. 波形特性の有効性

**Waveform Correlation**:
- 劣化に伴い1.0に近づく（波形の単純化）
- 単調増加パターン（物理的に妥当）

**VO/VL Variability**:
- 劣化に伴い増加（応答の不安定化）
- 単調増加パターン（物理的に妥当）

**Residual Energy Ratio**:
- 劣化に伴い増加（線形関係からの逸脱）
- 単調増加パターン（物理的に妥当）

### 3. 初期サイクルの扱い

**製品特性に基づく仮定**:
- 初期1-10サイクルは製品として必ず正常
- 製品は数サイクルで破損しない
- 時間情報ではなく、初期状態の特徴量パターンを学習

**One-Class SVM v2の結果**:
- Cycles 1-50: 77.0%異常検出（初期の一部を正常判定）
- Cycles 11以降: ほぼ全て異常検出
- 物理的に妥当な劣化検出

---

## 🎯 推奨アプローチ

### One-Class SVM v2（波形特性のみ）を推奨

**理由**:
1. **物理的妥当性**: 初期サイクルを正常、劣化サイクルを異常として検出
2. **特徴量選択**: 効率系特徴量を除外し、波形特性のみで学習
3. **単調性**: 劣化パターンが単調（回復なし）
4. **検出精度**: 91.9%の異常検出率（Cycles 51-100で100%）

**使用方法**:
- 初期1-10サイクルを正常として学習
- 波形特性（7特徴量）のみで異常検知
- 効率系特徴量は検証用として使用可能

**次のステップ**:
- タスク2.3: クラスタリングによる劣化パターン分類
- タスク2.4: 異常検知結果の妥当性検証
- Phase 3: 劣化度予測モデルの構築

---

## 📁 出力ファイル

### Isolation Forest
- `output/models_v3/isolation_forest.pkl`
- `output/anomaly_detection/isolation_forest_results.png`

### One-Class SVM v1
- `output/models_v3/one_class_svm.pkl`
- `output/anomaly_detection/one_class_svm_results.png`

### One-Class SVM v2（推奨）
- `output/models_v3/one_class_svm_v2.pkl`
- `output/models_v3/one_class_svm_v2_scaler.pkl`
- `output/models_v3/one_class_svm_v2_features.txt`
- `output/anomaly_detection/one_class_svm_v2_results.png`
- `output/anomaly_detection/one_class_svm_v2_results.csv`

---

**結論**: One-Class SVM v2（波形特性のみ）が最も物理的に妥当な異常検知を実現。効率系特徴量は劣化の結果であり、予測指標として不適切。波形特性のみで十分な異常検知が可能。
