# Confusion Matrix（混同行列）の詳細解説

## 1. 混同行列とは？

分類モデルの予測結果を、実際の正解と比較して整理した表です。

```
                予測結果
              Normal  Anomaly   合計
実際 Normal     27     173      200  ← 実際は正常なサイクル
    Anomaly     14     186      200  ← 実際は異常なサイクル
    合計        41     359      400
```

## 2. 4つのセルの意味

### ✅ True Negative (TN) = 27
**「正常を正常と正しく判定」**
- 実際：正常
- 予測：正常
- 結果：✅ 正解！

### ❌ False Positive (FP) = 173 ← **これが問題！**
**「正常なのに異常と誤判定」（誤報）**
- 実際：正常
- 予測：異常
- 結果：❌ 誤報！無駄な警告

### ❌ False Negative (FN) = 14
**「異常なのに正常と誤判定」（見逃し）**
- 実際：異常
- 予測：正常
- 結果：❌ 危険！異常を見逃した

### ✅ True Positive (TP) = 186
**「異常を異常と正しく判定」**
- 実際：異常
- 予測：異常
- 結果：✅ 正解！

## 3. 重要な評価指標

### False Positive Rate（誤報率）
```
FP Rate = FP / (TN + FP)
        = 173 / (27 + 173)
        = 173 / 200
        = 0.865
        = 86.5%
```

**意味**：実際に正常なサイクルのうち、86.5%を誤って異常と判定してしまう

### True Negative Rate（正常検出率）
```
TN Rate = TN / (TN + FP)
        = 27 / (27 + 173)
        = 27 / 200
        = 0.135
        = 13.5%
```

**意味**：実際に正常なサイクルのうち、13.5%しか正しく正常と判定できない

### Recall（再現率）
```
Recall = TP / (TP + FN)
       = 186 / (186 + 14)
       = 186 / 200
       = 0.93
       = 93.0%
```

**意味**：実際に異常なサイクルのうち、93.0%を正しく検出できる（良い！）

### Precision（適合率）
```
Precision = TP / (TP + FP)
          = 186 / (186 + 173)
          = 186 / 359
          = 0.518
          = 51.8%
```

**意味**：モデルが「異常」と判定したもののうち、51.8%が実際に異常（残り48.2%は誤報）

## 4. 実用上の問題

### シナリオ：工場での1ヶ月間の運用

**前提**：
- 監視対象：コンデンサ100個
- 実際の異常発生：月5個（5%）
- 正常動作：月95個（95%）

**モデルの予測結果**：
```
正常95個に対して：
  ✅ 正しく正常と判定：95 × 0.135 = 13個
  ❌ 誤って異常と判定：95 × 0.865 = 82個 ← 誤報！

異常5個に対して：
  ✅ 正しく異常と判定：5 × 0.93 = 5個
  ❌ 見逃し：5 × 0.07 = 0個
```

**結果**：
- **警告回数：87回**（5回は正しい、82回は誤報）
- **誤報率：94.3%**（87回中82回が誤報）

### コスト試算

```
1回の誤報対応コスト：
  - 点検作業：2時間 × 5,000円/時 = 10,000円
  - 生産ライン停止：1時間 × 50,000円/時 = 50,000円
  - 合計：60,000円/回

月間誤報コスト：
  82回 × 60,000円 = 4,920,000円/月
  
年間誤報コスト：
  4,920,000円 × 12ヶ月 = 59,040,000円/年
```

**約6,000万円/年の無駄なコストが発生！**

## 5. なぜこうなったのか？

### 学習データの問題

```
【学習時】
正常データ = Cycle 1-20のみ
  ↓
モデルが学習した「正常」の定義：
  「Cycle 1-20のような特徴を持つデータ」

【テスト時】
正常データ = Cycle 1-100
  ↓
Cycle 21-100は、Cycle 1-20とは少し異なる特徴
  ↓
モデル：「これは学習した正常パターンと違う！異常だ！」
  ↓
結果：誤報が大量発生
```

### 視覚的イメージ

```
Cycle 1-20（学習データ）
  ●●●●●●●●  ← モデルはこの範囲だけを「正常」と学習
  
Cycle 21-100（テストデータ）
  ●●●●●●●●○○○○○○○○○○○○
  ↑       ↑
  正常    モデルは「異常」と誤判定
```

## 6. 改善方法

### 方法1：学習データを増やす

```python
# 現在
正常データ = Cycle 1-20

# 改善案
正常データ = Cycle 1-50 または Cycle 1-100
```

**効果**：より多様な「正常」パターンを学習できる

### 方法2：閾値の調整

```python
# 現在
if anomaly_score < 0:  # 異常と判定
    alert()

# 改善案
if anomaly_score < -0.5:  # より厳しい閾値
    alert()
```

**効果**：誤報を減らせる（ただし見逃しが増える可能性）

### 方法3：アンサンブルアプローチ

```python
# 両方のモデルが異常と判定した場合のみ警告
if (anomaly_detection == "異常") AND (degradation_score > 0.5):
    alert()
```

**効果**：誤報を大幅に減らせる

### 方法4：段階的アラート

```python
if degradation_score < 0.25:
    # 何もしない（正常範囲）
elif degradation_score < 0.50:
    # 情報レベル：継続監視
elif degradation_score < 0.75:
    # 警告レベル：保全計画立案
else:
    # 緊急レベル：即時対応
```

**効果**：劣化度予測を主指標として使用（こちらは精度が高い）

## 7. 結論

### 現状の評価

**異常検知モデル**：
- ❌ False Positive Rate 86.5% → 実用不可
- ✅ Recall 93.0% → 異常の検出は得意
- 結論：**このままでは実用化できない**

**劣化度予測モデル**：
- ✅ R² 0.9617 → 非常に高精度
- ✅ MAE 0.0425 → 誤差が小さい
- 結論：**実用化可能**

### 推奨アプローチ

1. **劣化度予測モデルを主指標として使用**
2. **異常検知モデルは改善後に補助的に使用**
3. **段階的アラートシステムの構築**
4. **パイロット運用でデータ収集と閾値最適化**

## 8. 補足：他の評価指標

### Accuracy（正解率）
```
Accuracy = (TP + TN) / (TP + TN + FP + FN)
         = (186 + 27) / 400
         = 0.5325
         = 53.25%
```

**注意**：Accuracyだけでは誤報の多さが見えない！

### F1-Score
```
F1 = 2 × (Precision × Recall) / (Precision + Recall)
   = 2 × (0.518 × 0.93) / (0.518 + 0.93)
   = 0.6655
```

**注意**：F1-Scoreも誤報の多さを十分に反映しない！

**重要**：異常検知では**False Positive Rate**が最も重要な指標！

---

## まとめ

- **Normal-Normal = 27**は、200個中27個しか正しく正常と判定できていない
- **False Positive Rate = 86.5%**は、実用上許容できないレベル
- **誤報が多すぎて、現場が警告を信用しなくなる**（オオカミ少年効果）
- **改善なしでの実用化は推奨できない**
