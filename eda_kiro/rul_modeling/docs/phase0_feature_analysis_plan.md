# Phase 0: 特徴量分析プラン

## 🎯 目的

**モデル実装前に、どの特徴量が有効かを確認する**

EDAで劣化パターンは見えましたが、実際にモデルで予測できるかは別問題です。
まず相関分析で有効な特徴量を特定してから、本格的な実装に入ります。

## 📋 分析の流れ

### Step 1: 特徴量抽出の動作確認（10サイクル）

```python
# ES12C1の最初の10サイクルで試す
- 特徴量抽出ロジックが正しく動作するか確認
- 欠損値やNaNがないか確認
- 値の範囲が妥当か確認
```

**期待される出力**:
```
   cap_id  cycle  vl_mean  vo_mean  voltage_ratio  ...
0  ES12C1      1    5.234    4.123          0.787  ...
1  ES12C1      2    5.241    4.098          0.782  ...
...
```

### Step 2: 1つのコンデンサで相関分析（200サイクル）

```python
# ES12C1の全サイクルで特徴量を抽出
- RUL = 200 - cycle_number として計算
- 各特徴量とRULの相関係数を計算
- 相関係数の高い順にソート
```

**期待される結果**:
```
特徴量                      相関係数    p値
cycle_normalized            -1.000    0.000  # 定義上完全な負の相関
voltage_ratio               -0.850    0.000  # 強い負の相関
degradation_rate            -0.820    0.000
voltage_ratio_mean_last_5   -0.750    0.000
vo_mean                      0.450    0.001
vl_mean                      0.120    0.089  # 弱い相関
...
```

**判定基準**:
- **高相関**: |r| > 0.5 → 必須特徴量
- **中相関**: 0.3 < |r| < 0.5 → 有用な特徴量
- **低相関**: |r| < 0.3 → 削除候補

### Step 3: 複数コンデンサで一貫性確認（8個）

```python
# 全8個のコンデンサで相関係数を計算
- コンデンサごとの相関係数を比較
- 一貫して高い相関を持つ特徴量を特定
```

**期待される結果**:
```
特徴量                  C1     C2     C3     C4     C5     C6     C7     C8    平均
cycle_normalized      -1.00  -1.00  -1.00  -1.00  -1.00  -1.00  -1.00  -1.00  -1.00
voltage_ratio         -0.85  -0.82  -0.88  -0.79  -0.84  -0.81  -0.86  -0.83  -0.84
degradation_rate      -0.82  -0.79  -0.85  -0.76  -0.81  -0.78  -0.83  -0.80  -0.81
...
```

**判定基準**:
- **一貫性あり**: 全コンデンサで |r| > 0.3
- **一貫性なし**: コンデンサによって相関が大きく異なる → 削除候補

### Step 4: 簡単なRandom Forestで重要度確認

```python
# 1つのコンデンサでRandom Forestを学習
from sklearn.ensemble import RandomForestRegressor

model = RandomForestRegressor(n_estimators=100, random_state=42)
model.fit(X, y_rul)

# 特徴量重要度を取得
importances = model.feature_importances_
```

**期待される結果**:
```
特徴量                      重要度
cycle_normalized            0.350
voltage_ratio               0.180
degradation_rate            0.120
voltage_ratio_mean_last_5   0.080
...
```

**判定基準**:
- **高重要度**: importance > 0.05
- **低重要度**: importance < 0.01 → 削除候補

## 📊 分析結果の活用

### ケース1: 相関が高い特徴量が多い（10個以上）

→ **そのまま全特徴量を使ってモデル構築**

### ケース2: 相関が高い特徴量が少ない（5個未満）

→ **新規特徴量の追加を検討**

EDAの結果から追加候補:
- `voltage_ratio_change_rate`: 電圧比の変化率（前サイクルとの差分）
- `vo_vl_ratio_std_last_10`: 過去10サイクルの電圧比の標準偏差
- `time_since_threshold`: 電圧比が閾値を超えてからの経過サイクル数

### ケース3: 一貫性のない特徴量が多い

→ **コンデンサごとに異なる特性を考慮**
- コンデンサIDをカテゴリ変数として追加
- または、コンデンサごとに正規化

## 🎯 成功基準

Phase 0の完了条件：

- [ ] 特徴量抽出ロジックが正しく動作する
- [ ] **相関係数 |r| > 0.5 の特徴量を5個以上特定**
- [ ] 全コンデンサで一貫性のある特徴量を特定
- [ ] 削除候補の特徴量をリストアップ
- [ ] 追加候補の特徴量をリストアップ（必要に応じて）

## 🚀 実装方法

### Option 1: Jupyter Notebook（推奨）

```bash
# ノートブックで対話的に分析
rul_modeling/notebooks/00_exploratory_feature_analysis.ipynb
```

**利点**:
- 対話的に試行錯誤できる
- 可視化がしやすい
- 結果をすぐに確認できる

### Option 2: Pythonスクリプト

```bash
# スクリプトで一括実行
uv run python rul_modeling/scripts/exploratory_feature_analysis.py
```

**利点**:
- 再現性が高い
- 自動化しやすい

## 📈 次のステップ

Phase 0の結果を踏まえて：

### パターンA: 相関が高い特徴量が十分にある

1. **有効な特徴量のみ**を使ってデータセット構築
2. ベースラインモデルの学習
3. SHAPでさらに詳細な分析
4. モデル改善

### パターンB: 相関が低い、または一貫性がない

1. **新規特徴量の追加**を検討
2. EDAの結果を再確認
3. ドメイン知識を活用した特徴量設計
4. 再度相関分析

## 💡 重要なポイント

### 1. SHAPは後回し

SHAPは**モデルを学習した後**に使うツールです。
まずは相関分析で大まかな傾向を掴みましょう。

### 2. 完璧を求めない

Phase 0は**探索的分析**です。
完璧な特徴量セットを作る必要はありません。
「これで試してみよう」というレベルで十分です。

### 3. EDAの結果を信じる

EDAで**電圧比（voltage_ratio）が劣化指標として有効**なことは分かっています。
相関分析でもこれが確認できれば、自信を持って進められます。

## 🔗 参考資料

- **EDA結果**: `../output/large_gap_similar_vl_dissimilar_vo/SUMMARY.md`
- **設計書**: `.kiro/specs/rul_model_spec/design.md`
- **詳細設計**: `docs/rul_model_design.md`

---

**作成日**: 2026-01-15

まずはこの分析プランで進めましょう！
Jupyter Notebookで対話的に試すのがおすすめです 📊
