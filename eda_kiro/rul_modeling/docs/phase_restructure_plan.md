# Phase再構築計画: VL-VO関係性ベースの異常検知

## 📅 作成日: 2026-01-17

## 🎯 背景

Phase 2.6完了後、以下の根本的な問題が発見されました：

1. **RUL定義の問題**: `RUL = 200 - cycle_number`は単なるサイクル番号の逆算
2. **ラベルの恣意性**: Normal/Abnormalの分類が物理的根拠なし
3. **故障定義の欠如**: データに故障時点の情報がない

## 💡 新しいアプローチ

**VL-VO関係性の劣化検出**

コンデンサの劣化は、入力電圧（VL）に対する出力電圧（VO）の応答性の変化として現れる：
- **正常時**: VLに対してVOが適切に応答
- **劣化時**: VOの応答が鈍化（反応しない）または異常（ショート的な反応）

この物理的に意味のある関係性を基に、教師なし学習で異常検知を行う。

## 📋 新しいPhase構成

### Phase 0: 探索的特徴量分析（完了）
- 既存のPhase 0はそのまま維持
- VL/VO特徴量の相関分析完了

### Phase 1: VL-VO関係性分析（新規）

**目的**: VLとVOの関係性を可視化し、劣化パターンを理解する

#### Task 1.1: VL-VO関係性の可視化
- **目的**: サイクルごとのVL-VO関係を可視化し、劣化パターンを発見
- **実装内容**:
  - 各コンデンサの初期サイクル（1-10）と後期サイクル（190-200）のVL-VO散布図
  - サイクル進行に伴うVL-VO関係の変化を時系列プロット
  - voltage_ratioの時系列変化
  - 8コンデンサの比較可視化
- **出力**: `output/vl_vo_analysis/relationship_visualization.png`

#### Task 1.2: VL-VO応答性特徴量の設計
- **目的**: VL-VO関係性を定量化する新しい特徴量を設計
- **実装内容**:
  - 応答効率: `VO_energy / VL_energy`
  - 応答遅延: VLとVOの位相差（相互相関）
  - 波形類似度: VLとVOの相関係数
  - 初期状態からの偏差: 各特徴量の初期値（サイクル1-10平均）からの変化率
- **出力**: 新しい特徴量の定義ドキュメント

#### Task 1.3: 応答性特徴量の抽出
- **目的**: 設計した特徴量を全サイクルから抽出
- **実装内容**:
  - CycleFeatureExtractorの拡張
  - 応答性特徴量の計算実装
  - 全コンデンサ・全サイクルからの抽出
- **出力**: `output/features_v3/es12_features_with_response.csv`

#### Task 1.4: 劣化パターンの可視化
- **目的**: 応答性特徴量の時系列変化を可視化
- **実装内容**:
  - 応答効率の時系列プロット（8コンデンサ比較）
  - 応答遅延の時系列プロット
  - 初期状態からの偏差の可視化
  - 劣化速度の比較
- **出力**: `output/vl_vo_analysis/degradation_patterns.png`

### Phase 2: 異常検知モデル構築（再設計）

**目的**: 教師なし学習でVL-VO関係性の異常を検出

#### Task 2.1: 正常パターンの定義
- **目的**: 初期サイクル（1-50）を正常パターンとして定義
- **実装内容**:
  - 初期サイクルの応答性特徴量の統計分析
  - 正常範囲の定義（平均±2σ等）
  - 正常パターンの可視化
- **出力**: `output/anomaly_detection/normal_pattern_definition.md`

#### Task 2.2: Isolation Forestによる異常検知
- **目的**: 教師なし学習で異常サイクルを検出
- **実装内容**:
  - Isolation Forestモデルの構築
  - 異常度スコアの算出
  - 異常サイクルの特定
- **出力**: `output/models_v3/isolation_forest.pkl`

#### Task 2.3: クラスタリングによる劣化パターン分類
- **目的**: 劣化パターンを複数のクラスタに分類
- **実装内容**:
  - K-meansまたはDBSCANによるクラスタリング
  - 各クラスタの特徴分析
  - クラスタの可視化（PCA/t-SNE）
- **出力**: `output/anomaly_detection/clustering_results.png`

#### Task 2.4: 異常検知結果の評価
- **目的**: 検出された異常の妥当性を検証
- **実装内容**:
  - 異常サイクルの波形確認
  - 物理的解釈の検証
  - 8コンデンサ間の比較
- **出力**: `output/anomaly_detection/anomaly_validation_report.md`

### Phase 3: 劣化予測モデル構築（再設計）

**目的**: 応答性の劣化度を予測

#### Task 3.1: 劣化度の定義
- **目的**: 0（正常）から1（完全劣化）までの劣化度を定義
- **実装内容**:
  - 応答効率の正規化（初期値を1、最終値を0とする）
  - 劣化度の計算式の定義
  - 劣化度の可視化
- **出力**: `output/degradation_prediction/degradation_score_definition.md`

#### Task 3.2: 劣化度予測モデルの構築
- **目的**: 現在の特徴量から劣化度を予測
- **実装内容**:
  - Random Forest Regressorで劣化度を予測
  - Train/Val/Test分割（コンデンサベース）
  - モデルの学習と評価
- **出力**: `output/models_v3/degradation_predictor.pkl`

#### Task 3.3: 次サイクル応答性の予測
- **目的**: 次サイクルの応答性特徴量を予測
- **実装内容**:
  - 時系列予測モデル（LSTM or Random Forest）
  - 過去Nサイクルから次サイクルを予測
  - 予測精度の評価
- **出力**: `output/models_v3/response_predictor.pkl`

## 🎯 成功基準

### Phase 1完了条件
- [ ] VL-VO関係性の可視化完了
- [ ] 劣化パターンの発見と文書化
- [ ] 応答性特徴量の抽出完了

### Phase 2完了条件
- [ ] 異常検知モデルの構築完了
- [ ] 異常サイクルの特定と検証完了
- [ ] 物理的に妥当な異常検知結果

### Phase 3完了条件
- [ ] 劣化度予測モデルの構築完了
- [ ] 予測精度の評価完了
- [ ] 実用的な予測性能の達成

## 📊 期待される成果

1. **物理的に意味のある異常検知**: VL-VO関係性に基づく解釈可能な結果
2. **教師なし学習**: ラベル不要で異常を検出
3. **劣化の定量化**: 0-1スケールでの劣化度評価
4. **予測可能性**: 将来の劣化状態の予測

## 🔄 既存Phaseとの関係

- **Phase 0**: そのまま維持（特徴量の相関分析は有用）
- **Phase 1（旧）**: 廃止（データセット構築は新Phase 1で再実装）
- **Phase 2（旧）**: 廃止（Primary/Secondary Modelは不適切）
- **Phase 2.6**: 学習内容として保持（データリーケージの教訓）

## 📝 次のステップ

1. Task 1.1の実装: VL-VO関係性の可視化スクリプト作成
2. ES12C1の初期・後期サイクルでの関係性確認
3. 劣化パターンの発見と分析
4. Tasks.mdの更新

---

**作成者**: Kiro AI Agent  
**ステータス**: 計画承認待ち
